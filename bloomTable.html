<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="css/switch.css">
    <style>
        .bloomTable {
            border-collapse: collapse;
            border-spacing: 0;
            width: 100%;
        }
        
        th,
        td {
            border: none;
            text-align: left;
            padding: 8px;
        }

        .filter_div {
            display: none;
        }
    </style>
</head>

<body>
    <center>
        <h2>Bloom Table</h2></center>

    <p>
        This is a functional prototype as a proof of concept so no attention was given to asthetics, although the colors for the plants are rgb pulled from the MoBot image db.
        <br>The style elements will be derived from the squarespace css.
        <br>It builds the controls and table dynamically from json plant data which means we can add plants very easily. It also means we can refactor the plant data out to its own datastore to be used with other widgets.
        <br>The plants are sorted by relative hight with the tallest at the top and shortest at the bottom.
        <br>Right click on this page and select View Source to see the behind the scenes magic.
    </p>

    <p>
        <center>
            <input id="filterButton" class="btn" type="button" value="Filters" />
        </center>
        <div id="filters" class='filter_div'>
            <label class="switch">
                <input class="switch-input" type="checkbox" id='filter_size_short' filtertype='plantsize' filtervalue='short' checked/>
                <span class="switch-label" data-on="Short" data-off="Short"></span>
                <span class="switch-handle"></span>
            </label>

            <label class="switch">
                <input class="switch-input" type="checkbox" id='filter_size_med' filtertype='plantsize' filtervalue='med' checked/>
                <span class="switch-label" data-on="Medium" data-off="Medium"></span>
                <span class="switch-handle"></span>
            </label>

            <label class="switch">
                <input class="switch-input" type="checkbox" id='filter_size_tall' filtertype='plantsize' filtervalue='tall' checked/>
                <span class="switch-label" data-on="Tall" data-off="Tall"></span>
                <span class="switch-handle"></span>
            </label>


            <label class="switch">
                <input class="switch-input" type="checkbox" id='filter_bloom_early' filtertype='bloom' filtervalue='early' checked/>
                <span class="switch-label" data-on="Early" data-off="Early"></span>
                <span class="switch-handle"></span>
            </label>

            <label class="switch">
                <input class="switch-input" type="checkbox" id='filter_bloom_mid' filtertype='bloom' filtervalue='mid' checked/>
                <span class="switch-label" data-on="Mid" data-off="Mid"></span>
                <span class="switch-handle"></span>
            </label>

            <label class="switch">
                <input class="switch-input" type="checkbox" id='filter_bloom_late' filtertype='bloom' filtervalue='late' checked/>
                <span class="switch-label" data-on="Late" data-off="Late"></span>
                <span class="switch-handle"></span>
            </label>

        </div>
    </p>

    <p>
        <div id="plants">
        </div>
    </p>

    <center>
        <div style="overflow-x:auto;">
            <table class="bloomTable" id="bloomTable" rules="rows">
                <thead>
                    <tr id="header">
                        <th></th>
                        <th>April</th>
                        <th>May</th>
                        <th>June</th>
                        <th>July</th>
                        <th>August</th>
                        <th>September</th>
                        <th>October</th>
                    </tr>
                </thead>
                <tbody id="bloomTableBody">
                </tbody>
            </table>
        </div>
    </center>

</body>

<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
<script>
    //Tall
    var newenglandaster = JSON.parse('{"id": "newenglandaster", "name":"New England Aster", "start": 8, "end" : 9, "size" : "tall", "color":"#aa71c2", "bloom" : ["late"]}');

    //Medium
    var purpleconeflower = JSON.parse('{"id": "purpleconeflower", "name":"Purple Coneflower", "start": 6, "end" : 8, "size" : "med", "color":"#ff8ecf", "bloom" : ["mid","late"]}');
    var blazingstar = JSON.parse('{"id":"blazingstar", "name":"Prairie Blazing Star", "start": 7, "end" : 8, "size" : "med", "color":"#ad79b7", "bloom" : ["mid","late"]}');
    var pprairieclover = JSON.parse('{"id":"pprairieclover", "name":"Purple Prairie Clover", "start": 6, "end" : 8, "size" : "med", "color":"#b632a9", "bloom" : ["mid","late"]}');
    var bluestar = JSON.parse('{"id":"bluestar", "latin":"Amsonia ciliata", "name":"Blue Star", "start": 5, "end" : 5, "size" : "med", "color":"#acaed5", "bloom" : ["early"]}');
    var thimbleweed = JSON.parse('{"id":"thimbleweed", "latin":"Amsonia ciliata", "name":"Thimbleweed", "start": 4, "end" : 5, "size" : "med", "color":"white", "bloom" : ["early"]}');

    //Small
    var harebell = JSON.parse('{"id":"harebell", "name":"Harebell", "start": 6, "end" : 9, "size" : "short", "color":"#a4a8ff", "bloom" : ["mid", "late"]}');
    var loveleighest = JSON.parse('{"id":"loveleighest", "name":"MostLoveLeigh", "start": 6, "end" : 7, "size" : "short", "color":"#a4a8ff", "bloom" : ["mid"]}');

    $(document).ready(function () {

        initFilterButton();
        initSizeFilters();
        initBloomFilters();
        addSelectAll();
        buildTable();




        function buildTable() {
            var tallPlants = new Array(newenglandaster);
            var mediumPlants = new Array(purpleconeflower, blazingstar, pprairieclover, bluestar, thimbleweed);
            var smallPlants = new Array(harebell, loveleighest);

            addToTable(tallPlants);
            addToTable(mediumPlants);
            addToTable(smallPlants);
        }



        function addToTable(plantArray) {
            var $table = $('#bloomTableBody');
            plantArray.forEach(function (plant) {

                addCheckbox(plant);

                var $row = $('<tr>')
                    .attr('id', plant.id + '_row')
                    .attr("plantsize", plant.size)
                    .attr("bloom", plant.bloom)
                    .attr("plantid", plant.id)
                    .css("display", "none")
                    .appendTo($table);

                $row.addClass("plantRow");

                $('<td>')
                    .text(plant.name)
                    .appendTo($row);

                for (i = 4; i <= 10; i++) {
                    if (i >= plant.start && i <= plant.end) {
                        if (plant.color == 'white') {
                            var $td = $('<td>');
                            $td.css("border-top", "1px solid #4f4f4f");
                            $td.css("border-bottom", "1px solid #4f4f4f");
                            if (i == plant.start) {
                                $td.css("border-left", "1px solid #4f4f4f");
                            } else if (i == plant.end) {
                                $td.css("border-right", "1px solid #4f4f4f");
                            }
                            $td.appendTo($row);
                        } else {
                            $('<td>')
                                .css("background-color", plant.color)
                                .appendTo($row);
                        }
                    } else {
                        $('<td>')
                            .appendTo($row);
                    }
                }
            });
        }

    });



    function addCheckbox(plant) {
        var container = $('#plants');

        var label = $('<label />', {
            id: plant.id + "_label",
            'plantid': plant.id,
            text: plant.name
        });
        label.addClass("plantCheckboxLabel");
        label.attr("plantsize", plant.size)
            .attr("bloom", plant.bloom);

        var checkbox = $('<input />', {
            type: 'checkbox',
            id: plant.id + "_checkbox",
            'plantid': plant.id,
            value: plant.id
        });

        checkbox.addClass("plantCheckbox");
        checkbox.change(function (e) {
            var row = $('#' + plant.id + "_row");
            if (this.checked) {
                localStorage.setItem("plantselected_" + plant.id, "true");
                row.css("display", "");
            } else {
                localStorage.setItem("plantselected_" + plant.id, "false");
                row.css("display", "none");
            }

        });
        checkbox.prependTo(label);

        label.appendTo(container);
        localStorage.setItem("plantselected_" + plant.id, "false");

        //        $('<br>').appendTo(container);
    }




    function addSelectAll() {
        var container = $('#plants');

        var checkbox = $('<input />', {
            type: 'checkbox',
            id: 'selectAll',
            className: "selectAll",
            value: "selectAll"
        });

        checkbox.change(function (e) {
            $(".plantCheckbox").prop('checked', $(this).prop('checked')).change();
        });

        checkbox.appendTo(container);

        $('<label />', {
            'for': 'selectAll',
            text: 'Select All'
        }).appendTo(container);

        $('<br>').appendTo(container);
    }

    function initFilterButton() {
        $("#filterButton").click(function () {
            $("#filters").slideToggle("slow");
        });
    }




    function initSizeFilters() {
        $(".switch-input[filtertype=plantsize]").change(function (e) {
            var filterType = $(this).attr("filtertype");
            var filterValue = $(this).attr('filtervalue');
            var visible = $(this).prop('checked');
            filterSizeCheckboxes(filterType, filterValue, visible);
            filterSizeTableRows(filterType, filterValue, visible);
        });
    }

    function initBloomFilters() {
        $(".switch-input[filtertype=bloom]").change(function (e) {
            var bloomFilterStates = {};

            $(".switch-input[filtertype=bloom]").each(function () {
                var filterValue = $(this).attr('filtervalue');
                var visible = $(this).prop('checked');

                bloomFilterStates[filterValue] = visible;
            });
            filterBloomCheckboxes(bloomFilterStates);
            //            filterBloomTableRows(bloomFilterStates);
        });
    }

    //bloomFilterStates = [{bloomPeriod: "early", bloomVisible: true}, {bloomPeriod: "mid", bloomVisible: false}, {bloomPeriod: "late", bloomVisible: false}]
    function filterBloomCheckboxes(bloomFilterStates) {
        $(".plantCheckboxLabel").each(function () {
            var thisPlantBloomPeriods = $(this).attr('bloom').split(',');
            var p = $(this).attr('plantid');
            var bloomVisible = [];

            for (var i = 0; i < thisPlantBloomPeriods.length; i++) {
                bloomVisible.push(bloomFilterStates[thisPlantBloomPeriods[i]]);
            }

            var plantBloomPeriodsVisibilityEqual = bloomVisible.allValuesSame();

            if (plantBloomPeriodsVisibilityEqual) {
                console.log($(this).attr('plantid') + ":" + bloomVisible[0])
                if (bloomVisible[0]) {
                    $('#' + $(this).prop('id')).css("display", "");
                } else {
                    $('#' + $(this).prop('id')).css("display", "none");
                }
            }
        });
    }

    function filterBloomTableRows(bloomFilterStates) {
        $(".plantRow").each(function () {
            if (($(this).attr(filterType) == filterValue)) {
                var rowId = $(this).attr('id');
                if (visible) {
                    var isPlantSelected = localStorage.getItem("plantselected_" + $(this).attr('plantid'));
                    if (isPlantSelected == "true") {
                        $('#' + rowId).css("display", "");
                    }
                } else {
                    $('#' + rowId).css("display", "none");
                }
            }
        });
    }


    function filterSizeCheckboxes(filterType, filterValue, visible) {
        $(".plantCheckboxLabel").each(function () {
            if (($(this).attr(filterType) == filterValue)) {
                var checkBoxId = $(this).prop('id');
                if (visible) {
                    $('#' + checkBoxId).css("display", "");
                } else {
                    $('#' + checkBoxId).css("display", "none");
                }
            }
        });
    }

    function filterSizeTableRows(filterType, filterValue, visible) {
        $(".plantRow").each(function () {
            if (($(this).attr(filterType) == filterValue)) {
                var rowId = $(this).attr('id');
                if (visible) {
                    var isPlantSelected = localStorage.getItem("plantselected_" + $(this).attr('plantid'));
                    if (isPlantSelected == "true") {
                        $('#' + rowId).css("display", "");
                    }
                } else {
                    $('#' + rowId).css("display", "none");
                }
            }
        });
    }


    Array.prototype.allValuesSame = function () {

        for (var i = 1; i < this.length; i++) {
            if (this[i] !== this[0])
                return false;
        }

        return true;
    }
</script>

</html>
