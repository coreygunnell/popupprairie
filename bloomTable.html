<!DOCTYPE html>
<html>

<head>
    <style>
        .bloomTable {
            border-collapse: collapse;
            border-spacing: 0;
            width: 100%;
        }
        
        th,
        td {
            border: none;
            text-align: left;
            padding: 8px;
        }

        .plants_div {
            display: none;
        }

        .plantCheckboxLabel {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <center>
        <h2>Bloom Table</h2></center>


    <p>
        <center>
            <input id="plantsButton" class="btn" type="button" value="Plants" />
        </center>
    </p>

    <p>
        <div id="plants" class='plants_div'>
        </div>
    </p>

    <center>
        <div style="overflow-x:auto;">
            <table class="bloomTable" id="bloomTable" rules="rows">
                <thead>
                    <tr id="header">
                        <th></th>
                        <th>April</th>
                        <th>May</th>
                        <th>June</th>
                        <th>July</th>
                        <th>August</th>
                        <th>September</th>
                        <th>October</th>
                    </tr>
                </thead>
                <tbody id="bloomTableBody">
                </tbody>
            </table>
        </div>
    </center>

    <p>
        <div class='sqftcacl_div'>
            Installation square footage:
            <input type="number" id='sqftinput' name="sqft" min="1" value=0>
        </div>

        <div style="overflow-x:auto;">
            <table class="sqftTable" id="sqftTable" rules="rows">
                <thead>
                    <tr id="header">
                        <th>Plants</th>
                    </tr>
                </thead>
                <tbody id="sqftTableBody">
                </tbody>
            </table>
        </div>
    </p>

</body>

<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
<script>
    //Tall
    var newenglandaster = JSON.parse('{"id": "newenglandaster", "name":"New England Aster", "start": 8, "end" : 9, "size" : "tall", "spacing": "2.5", "color":"#aa71c2", "bloom" : ["late"]}');

    //Medium
    var purpleconeflower = JSON.parse('{"id": "purpleconeflower", "name":"Purple Coneflower", "start": 6, "end" : 8, "size" : "med", "spacing": "1.5","color":"#ff8ecf", "bloom" : ["mid","late"]}');
    var blazingstar = JSON.parse('{"id":"blazingstar", "name":"Prairie Blazing Star", "start": 7, "end" : 8, "size" : "med", "spacing": "1","color":"#ad79b7", "bloom" : ["mid","late"]}');
    var pprairieclover = JSON.parse('{"id":"pprairieclover", "name":"Purple Prairie Clover", "start": 6, "end" : 8, "size" : "med", "spacing": "1.5","color":"#b632a9", "bloom" : ["mid","late"]}');
    var bluestar = JSON.parse('{"id":"bluestar", "latin":"Amsonia ciliata", "name":"Blue Star", "start": 5, "end" : 5, "size" : "med", "spacing": "3","color":"#acaed5", "bloom" : ["early"]}');
    var thimbleweed = JSON.parse('{"id":"thimbleweed", "latin":"Amsonia ciliata", "name":"Thimbleweed", "start": 4, "end" : 5, "size" : "med", "spacing": "1","color":"white", "bloom" : ["early"]}');

    //Small
    var harebell = JSON.parse('{"id":"harebell", "name":"Harebell", "start": 6, "end" : 9, "size" : "short", "spacing": ".5","color":"#a4a8ff", "bloom" : ["mid", "late"]}');
    var loveleighest = JSON.parse('{"id":"loveleighest", "name":"MostLoveLeigh", "start": 6, "end" : 7, "size" : "short", "spacing": "1","color":"#a4a8ff", "bloom" : ["mid"]}');

    var selectedPlants = new Array();

    $(document).ready(function () {

        initPlantsButton();
        buildTable();
        addSelectAll();
        initSqFtCalc();


    });

    function buildTable() {
        var tallPlants = new Array(newenglandaster);
        var mediumPlants = new Array(purpleconeflower, blazingstar, pprairieclover, bluestar, thimbleweed);
        var smallPlants = new Array(harebell, loveleighest);

        addToTable(tallPlants);
        addToTable(mediumPlants);
        addToTable(smallPlants);
    }


    function initSqFtCalc() {
        $('#sqftinput').change(function () {
            calcSqFt()
        });
    }


    function getMinSqFtFromSelected() {
        var min = -1;
        for (i = 0; i < selectedPlants.length; i++) {
            var plant = JSON.parse(selectedPlants[i]);
            var plantspacing = (parseFloat(plant.spacing) * 12) * (parseFloat(plant.spacing) * 12);
            if (min == -1 || plantspacing < min) {
                min = plantspacing
            }
        }

        return min;
    }

    function calcSqFt() {
        var sqft = parseInt($('#sqftinput').val(), 10);
        var sqftinch = sqft * 144;
        var plantCount = [];
        var minSpacing = getMinSqFtFromSelected();
        console.log('minSpacing: ' + minSpacing);
        while (sqftinch > minSpacing) {
            console.log('sqft ' + sqftinch + ">  min " + minSpacing);
            for (i = 0; i < selectedPlants.length; i++) {
                var plant = JSON.parse(selectedPlants[i]);
                var plantId = plant.id;
                var plantspacing = (parseFloat(plant.spacing) * 12) * (parseFloat(plant.spacing) * 12);
                if (sqftinch >= plantspacing) {
                    sqftinch = sqftinch - plantspacing;
                    console.log('subtracting for ' + plantId + "-" + plantspacing + '. New sqft = ' + sqftinch);
                    if (sqftinch >= 0) {
                        console.log('sqft: ' + sqftinch + " - " + plantId + " fits - " + plantspacing);
                        if ($.inArray(plantId, Object.keys(plantCount)) >= 0) {
                            plantCount[plantId] = plantCount[plantId] + 1;
                            console.log(plantId + ': ' + plantCount[plantId]);
                        } else {
                            plantCount[plantId] = 1;
                        }

                    } else {
                        break;
                    }
                }
                else{
                    console.log('sqft: ' + sqftinch + " - " + plantId + " does Not fit - " + plantspacing);
                }
            };
        }

        var $table = $('#sqftTableBody');
        $table.empty();
        if (selectedPlants.length > Object.keys(plantCount).length) {
            var $row = $('<tr>').appendTo($table);
            $('<td>')
                .text('You have too many plants selected for ' + $('#sqftinput').val() + " square feet.")
                .appendTo($row);
        } else {
            Object.keys(plantCount).forEach(function (plant) {
                var $row = $('<tr>').appendTo($table);
                $('<td>')
                    .text(plant + ': ' + plantCount[plant])
                    .appendTo($row);
            });
        }

    }


    function addToTable(plantArray) {
        var $table = $('#bloomTableBody');
        plantArray.forEach(function (plant) {

            addCheckbox(plant);

            var $row = $('<tr>')
                .attr('id', plant.id + '_row')
                .attr("plantsize", plant.size)
                .attr("bloom", plant.bloom)
                .attr("plantid", plant.id)
                .attr('filters', plant.size + ',' + plant.bloom)
                .css("display", "none")
                .appendTo($table);

            $row.addClass("plantRow");
            $row.click(function () {
                $('#' + plant.id + '_checkbox').prop('checked', false).change();
                removePlant(plant);
                calcSqFt();
            });


            var $td = $('<td>')
                .text(plant.name)
                .appendTo($row);


            for (i = 4; i <= 10; i++) {
                var $td = $('<td>');
                if (i >= plant.start && i <= plant.end) {

                    if (plant.size != 'med') {
                        $td.html((plant.size == 'tall') ? '&uarr;' : '&darr;');
                    }

                    if (plant.color == 'white') {
                        $td.css("border-top", "1px solid #4f4f4f");
                        $td.css("border-bottom", "1px solid #4f4f4f");
                        if (i == plant.start) {
                            $td.css("border-left", "1px solid #4f4f4f");
                        } else if (i == plant.end) {
                            $td.css("border-right", "1px solid #4f4f4f");
                        }
                    } else {
                        $td.css("background-color", plant.color)
                    }
                }

                $td.appendTo($row);
            }
        });
    }



    function removePlant(plant) {
        for (var i = selectedPlants.length - 1; i >= 0; i--) {
            var selectedPlant = JSON.parse(selectedPlants[i]);
            if (selectedPlant.id == plant.id) {
                selectedPlants.splice(i, 1);
                break; //<-- Uncomment  if only the first term has to be removed
            }
        }
    }


    function addPlant(plant) {
        //probably don't need to check for existence
        selectedPlants.push(JSON.stringify(plant));
    }


    function addCheckbox(plant) {
        var container = $('#plants');

        var label = $('<label />', {
            id: plant.id + "_label",
            'plantid': plant.id,
        });
        label.addClass("plantCheckboxLabel");
        label.attr("plantsize", plant.size)
            .attr('filters', plant.size + ',' + plant.bloom)
            .attr("bloom", plant.bloom);

        if (plant.size == 'med') {
            label.html(plant.name);
        } else {
            label.html((plant.size == 'tall') ? plant.name + ' &uarr;' : plant.name + ' &darr;');
        }

        if (plant.color != 'white') {
            label.css('color', plant.color);
        }

        var checkbox = $('<input />', {
            type: 'checkbox',
            id: plant.id + "_checkbox",
            'plantid': plant.id,
            value: plant.id
        });


        checkbox.addClass("plantCheckbox");
        checkbox.change(function (e) {
            var row = $('#' + plant.id + "_row");
            if (this.checked) {
                addPlant(plant);
                row.css("display", "");
            } else {
                row.css("display", "none");
                $("#selectAll").prop("checked", false);
                removePlant(plant);
            }

            calcSqFt();

        });
        checkbox.prependTo(label);

        label.appendTo(container);
    }




    function addSelectAll() {
        var container = $('#plants');

        var checkbox = $('<input />', {
            type: 'checkbox',
            id: 'selectAll',
            className: "selectAll",
            value: "selectAll"
        });

        checkbox.change(function (e) {
            $(".plantCheckbox").prop('checked', $(this).prop('checked')).change();
        });

        checkbox.prop("checked", true).change();

        checkbox.appendTo(container);

        $('<label />', {
            'for': 'selectAll',
            text: 'Select All'
        }).appendTo(container);

        $('<br>').appendTo(container);
    }

    function initPlantsButton() {
        $("#plantsButton").click(function () {
            $("#plants").slideToggle("slow");
        });
    }




    Array.prototype.allValuesSame = function () {

        for (var i = 1; i < this.length; i++) {
            if (this[i] !== this[0])
                return false;
        }

        return true;
    }
</script>

</html>
